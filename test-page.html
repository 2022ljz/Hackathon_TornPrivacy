<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIONEER DeFi - æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        h1 {
            color: #22c55e;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: white;
            padding: 10px;
            border-radius: 6px;
            width: 200px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸŒªï¸ PIONEER DeFi Platform - æµ‹è¯•é¡µé¢</h1>

        <div class="test-section">
            <h3>ğŸ“± é’±åŒ…è¿æ¥æµ‹è¯•</h3>
            <button onclick="connectWallet()">è¿æ¥ MetaMask</button>
            <div id="walletInfo"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’° ETH å­˜æ¬¾æµ‹è¯•</h3>
            <input type="number" id="depositAmount" placeholder="0.01" step="0.001" value="0.01">
            <label>ETH</label><br>
            <button onclick="depositETH()" id="depositBtn" disabled>å­˜å…¥ ETH</button>
            <div id="depositInfo"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¦ å€Ÿè´·æµ‹è¯•</h3>
            <input type="number" id="borrowAmount" placeholder="5" value="5">
            <label>DAI</label><br>
            <button onclick="borrowDAI()" id="borrowBtn" disabled>å€Ÿå…¥ DAI</button>
            <div id="borrowInfo"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¸ æå–æµ‹è¯•</h3>
            <button onclick="withdrawETH()" id="withdrawBtn" disabled>æå– ETH</button>
            <div id="withdrawInfo"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š åˆçº¦çŠ¶æ€</h3>
            <button onclick="checkContractStatus()">æ£€æŸ¥åˆçº¦çŠ¶æ€</button>
            <div id="contractStatus"></div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js"></script>
    <script>
        // åˆçº¦é…ç½®
        const CONTRACT_CONFIG = {
            MIXER_ADDRESS: "0xf85Daa3dBA126757027CE967F86Eb7860271AfE0",
            LENDING_POOL_ADDRESS: "0x79D681b26F8012b59Ed1726241168aF367cDb7Ad",
            COLLATERAL_MANAGER_ADDRESS: "0xC9BAe3f8F6A47Daf0847294096906d91B8eF0f1d",
            DAI_ADDRESS: "0x3a6B9cC96D2FB5bCA277C0A222CE16Ab6bAeF5B4"
        };

        // åˆçº¦ ABI (ç®€åŒ–ç‰ˆ)
        const MIXER_ABI = [
            "function deposit(bytes32 commitment, address token, uint256 amount) payable",
            "function withdraw(address to, bytes32 nullifier, bytes32 secret)",
            "function getDeposit(bytes32 commitment) view returns (address, uint256, bool, bool)"
        ];

        const COLLATERAL_MANAGER_ABI = [
            "function lockAndBorrow(bytes32 commitment, address borrowToken, uint256 borrowAmount)",
            "function repayAndUnlock(bytes32 commitment, uint256 repayAmount)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)"
        ];

        let provider, signer, userAddress;
        let currentCommitment, currentNullifier, currentSecret;

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('è¯·å®‰è£… MetaMask');
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = signer.address;

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111n) {
                    throw new Error('è¯·åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘');
                }

                // è·å–ä½™é¢
                const balance = await provider.getBalance(userAddress);
                const ethBalance = ethers.formatEther(balance);

                document.getElementById('walletInfo').innerHTML = `
                    <div class="info">
                        <strong>âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼</strong><br>
                        åœ°å€: ${userAddress}<br>
                        ç½‘ç»œ: Sepolia (${network.chainId})<br>
                        ETH ä½™é¢: ${ethBalance} ETH
                    </div>
                `;

                // å¯ç”¨æŒ‰é’®
                document.getElementById('depositBtn').disabled = false;
                document.getElementById('borrowBtn').disabled = false;
                document.getElementById('withdrawBtn').disabled = false;

            } catch (error) {
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // ç”Ÿæˆéšç§å‡­è¯
        function generateCommitment() {
            currentNullifier = ethers.randomBytes(32);
            currentSecret = ethers.randomBytes(32);
            currentCommitment = ethers.keccak256(
                ethers.concat([currentNullifier, currentSecret])
            );
            return currentCommitment;
        }

        // å­˜å…¥ ETH
        async function depositETH() {
            try {
                const amount = document.getElementById('depositAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢');
                }

                const amountWei = ethers.parseEther(amount);
                const commitment = generateCommitment();

                const mixerContract = new ethers.Contract(
                    CONTRACT_CONFIG.MIXER_ADDRESS,
                    MIXER_ABI,
                    signer
                );

                document.getElementById('depositInfo').innerHTML = `
                    <div class="info">ğŸ“¤ æ­£åœ¨å­˜å…¥ ${amount} ETH...</div>
                `;

                const tx = await mixerContract.deposit(
                    commitment,
                    ethers.ZeroAddress, // ETH ä½¿ç”¨é›¶åœ°å€
                    amountWei,
                    { value: amountWei }
                );

                document.getElementById('depositInfo').innerHTML = `
                    <div class="info">â³ äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...<br>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}</div>
                `;

                await tx.wait();

                document.getElementById('depositInfo').innerHTML = `
                    <div class="info">
                        <strong>âœ… å­˜æ¬¾æˆåŠŸï¼</strong><br>
                        é‡‘é¢: ${amount} ETH<br>
                        äº¤æ˜“å“ˆå¸Œ: ${tx.hash}<br>
                        éšç§å‡­è¯: ${commitment}<br>
                        <small>è¯·ä¿å­˜å¥½æ‚¨çš„éšç§å‡­è¯ï¼Œæå–æ—¶éœ€è¦ä½¿ç”¨</small>
                    </div>
                `;

            } catch (error) {
                document.getElementById('depositInfo').innerHTML = `
                    <div class="error">âŒ å­˜æ¬¾å¤±è´¥: ${error.message}</div>
                `;
                console.error('å­˜æ¬¾é”™è¯¯:', error);
            }
        }

        // å€Ÿå…¥ DAI
        async function borrowDAI() {
            try {
                if (!currentCommitment) {
                    throw new Error('è¯·å…ˆè¿›è¡Œ ETH å­˜æ¬¾');
                }

                const amount = document.getElementById('borrowAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å€Ÿæ¬¾é‡‘é¢');
                }

                const amountWei = ethers.parseUnits(amount, 18); // DAI æ˜¯ 18 ä½å°æ•°

                const collateralManagerContract = new ethers.Contract(
                    CONTRACT_CONFIG.COLLATERAL_MANAGER_ADDRESS,
                    COLLATERAL_MANAGER_ABI,
                    signer
                );

                document.getElementById('borrowInfo').innerHTML = `
                    <div class="info">ğŸ“¤ æ­£åœ¨å€Ÿå…¥ ${amount} DAI...</div>
                `;

                const tx = await collateralManagerContract.lockAndBorrow(
                    currentCommitment,
                    CONTRACT_CONFIG.DAI_ADDRESS,
                    amountWei
                );

                document.getElementById('borrowInfo').innerHTML = `
                    <div class="info">â³ äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...<br>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}</div>
                `;

                await tx.wait();

                // æ£€æŸ¥ DAI ä½™é¢
                const daiContract = new ethers.Contract(
                    CONTRACT_CONFIG.DAI_ADDRESS,
                    ERC20_ABI,
                    signer
                );
                const daiBalance = await daiContract.balanceOf(userAddress);
                const daiBalanceFormatted = ethers.formatUnits(daiBalance, 18);

                document.getElementById('borrowInfo').innerHTML = `
                    <div class="info">
                        <strong>âœ… å€Ÿæ¬¾æˆåŠŸï¼</strong><br>
                        å€Ÿå…¥é‡‘é¢: ${amount} DAI<br>
                        å½“å‰ DAI ä½™é¢: ${daiBalanceFormatted} DAI<br>
                        äº¤æ˜“å“ˆå¸Œ: ${tx.hash}
                    </div>
                `;

            } catch (error) {
                document.getElementById('borrowInfo').innerHTML = `
                    <div class="error">âŒ å€Ÿæ¬¾å¤±è´¥: ${error.message}</div>
                `;
                console.error('å€Ÿæ¬¾é”™è¯¯:', error);
            }
        }

        // æå– ETH
        async function withdrawETH() {
            try {
                if (!currentCommitment || !currentNullifier || !currentSecret) {
                    throw new Error('è¯·å…ˆè¿›è¡Œå­˜æ¬¾å’Œå€Ÿè´·æ“ä½œ');
                }

                const mixerContract = new ethers.Contract(
                    CONTRACT_CONFIG.MIXER_ADDRESS,
                    MIXER_ABI,
                    signer
                );

                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="info">ğŸ“¤ æ­£åœ¨æå– ETH...</div>
                `;

                const tx = await mixerContract.withdraw(
                    userAddress,
                    currentNullifier,
                    currentSecret
                );

                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="info">â³ äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...<br>äº¤æ˜“å“ˆå¸Œ: ${tx.hash}</div>
                `;

                await tx.wait();

                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="info">
                        <strong>âœ… æå–æˆåŠŸï¼</strong><br>
                        äº¤æ˜“å“ˆå¸Œ: ${tx.hash}<br>
                        ETH å·²è¿”å›åˆ°æ‚¨çš„é’±åŒ…
                    </div>
                `;

            } catch (error) {
                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="error">âŒ æå–å¤±è´¥: ${error.message}</div>
                `;
                console.error('æå–é”™è¯¯:', error);
            }
        }

        // æ£€æŸ¥åˆçº¦çŠ¶æ€
        async function checkContractStatus() {
            try {
                if (!provider) {
                    throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                }

                document.getElementById('contractStatus').innerHTML = `
                    <div class="info">ğŸ“Š æ­£åœ¨æ£€æŸ¥åˆçº¦çŠ¶æ€...</div>
                `;

                // æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦æœ‰ä»£ç 
                const mixerCode = await provider.getCode(CONTRACT_CONFIG.MIXER_ADDRESS);
                const lendingPoolCode = await provider.getCode(CONTRACT_CONFIG.LENDING_POOL_ADDRESS);
                const collateralManagerCode = await provider.getCode(CONTRACT_CONFIG.COLLATERAL_MANAGER_ADDRESS);

                let status = `
                    <div class="info">
                        <strong>ğŸ“‹ åˆçº¦çŠ¶æ€æ£€æŸ¥</strong><br>
                        Mixer: ${mixerCode !== '0x' ? 'âœ… å·²éƒ¨ç½²' : 'âŒ æœªéƒ¨ç½²'}<br>
                        LendingPool: ${lendingPoolCode !== '0x' ? 'âœ… å·²éƒ¨ç½²' : 'âŒ æœªéƒ¨ç½²'}<br>
                        CollateralManager: ${collateralManagerCode !== '0x' ? 'âœ… å·²éƒ¨ç½²' : 'âŒ æœªéƒ¨ç½²'}<br>
                `;

                // å¦‚æœæœ‰å½“å‰å­˜æ¬¾ï¼Œæ£€æŸ¥å­˜æ¬¾çŠ¶æ€
                if (currentCommitment) {
                    const mixerContract = new ethers.Contract(
                        CONTRACT_CONFIG.MIXER_ADDRESS,
                        MIXER_ABI,
                        provider
                    );

                    const depositInfo = await mixerContract.getDeposit(currentCommitment);
                    status += `
                        <br><strong>å½“å‰å­˜æ¬¾çŠ¶æ€:</strong><br>
                        ä»£å¸: ${depositInfo[0] === ethers.ZeroAddress ? 'ETH' : depositInfo[0]}<br>
                        é‡‘é¢: ${ethers.formatEther(depositInfo[1])} ETH<br>
                        å·²æå–: ${depositInfo[2] ? 'æ˜¯' : 'å¦'}<br>
                        å·²é”å®š: ${depositInfo[3] ? 'æ˜¯' : 'å¦'}
                    `;
                }

                status += '</div>';
                document.getElementById('contractStatus').innerHTML = status;

            } catch (error) {
                document.getElementById('contractStatus').innerHTML = `
                    <div class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>
                `;
                console.error('çŠ¶æ€æ£€æŸ¥é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', function () {
            if (!window.ethereum) {
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">
                        âŒ æœªæ£€æµ‹åˆ° MetaMask<br>
                        è¯·å®‰è£… MetaMask æµè§ˆå™¨æ’ä»¶ååˆ·æ–°é¡µé¢
                    </div>
                `;
            }
        });
    </script>
</body>

</html>