<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIONEER DeFi - 测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        h1 {
            color: #22c55e;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: white;
            padding: 10px;
            border-radius: 6px;
            width: 200px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🌪️ PIONEER DeFi Platform - 测试页面</h1>

        <div class="test-section">
            <h3>📱 钱包连接测试</h3>
            <button onclick="connectWallet()">连接 MetaMask</button>
            <div id="walletInfo"></div>
        </div>

        <div class="test-section">
            <h3>💰 ETH 存款测试</h3>
            <input type="number" id="depositAmount" placeholder="0.01" step="0.001" value="0.01">
            <label>ETH</label><br>
            <button onclick="depositETH()" id="depositBtn" disabled>存入 ETH</button>
            <div id="depositInfo"></div>
        </div>

        <div class="test-section">
            <h3>🏦 借贷测试</h3>
            <input type="number" id="borrowAmount" placeholder="5" value="5">
            <label>DAI</label><br>
            <button onclick="borrowDAI()" id="borrowBtn" disabled>借入 DAI</button>
            <div id="borrowInfo"></div>
        </div>

        <div class="test-section">
            <h3>💸 提取测试</h3>
            <button onclick="withdrawETH()" id="withdrawBtn" disabled>提取 ETH</button>
            <div id="withdrawInfo"></div>
        </div>

        <div class="test-section">
            <h3>📊 合约状态</h3>
            <button onclick="checkContractStatus()">检查合约状态</button>
            <div id="contractStatus"></div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js"></script>
    <script>
        // 合约配置
        const CONTRACT_CONFIG = {
            MIXER_ADDRESS: "0xf85Daa3dBA126757027CE967F86Eb7860271AfE0",
            LENDING_POOL_ADDRESS: "0x79D681b26F8012b59Ed1726241168aF367cDb7Ad",
            COLLATERAL_MANAGER_ADDRESS: "0xC9BAe3f8F6A47Daf0847294096906d91B8eF0f1d",
            DAI_ADDRESS: "0x3a6B9cC96D2FB5bCA277C0A222CE16Ab6bAeF5B4"
        };

        // 合约 ABI (简化版)
        const MIXER_ABI = [
            "function deposit(bytes32 commitment, address token, uint256 amount) payable",
            "function withdraw(address to, bytes32 nullifier, bytes32 secret)",
            "function getDeposit(bytes32 commitment) view returns (address, uint256, bool, bool)"
        ];

        const COLLATERAL_MANAGER_ABI = [
            "function lockAndBorrow(bytes32 commitment, address borrowToken, uint256 borrowAmount)",
            "function repayAndUnlock(bytes32 commitment, uint256 repayAmount)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)"
        ];

        let provider, signer, userAddress;
        let currentCommitment, currentNullifier, currentSecret;

        // 连接钱包
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('请安装 MetaMask');
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = signer.address;

                // 检查网络
                const network = await provider.getNetwork();
                if (network.chainId !== 11155111n) {
                    throw new Error('请切换到 Sepolia 测试网');
                }

                // 获取余额
                const balance = await provider.getBalance(userAddress);
                const ethBalance = ethers.formatEther(balance);

                document.getElementById('walletInfo').innerHTML = `
                    <div class="info">
                        <strong>✅ 钱包连接成功！</strong><br>
                        地址: ${userAddress}<br>
                        网络: Sepolia (${network.chainId})<br>
                        ETH 余额: ${ethBalance} ETH
                    </div>
                `;

                // 启用按钮
                document.getElementById('depositBtn').disabled = false;
                document.getElementById('borrowBtn').disabled = false;
                document.getElementById('withdrawBtn').disabled = false;

            } catch (error) {
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">❌ 连接失败: ${error.message}</div>
                `;
            }
        }

        // 生成隐私凭证
        function generateCommitment() {
            currentNullifier = ethers.randomBytes(32);
            currentSecret = ethers.randomBytes(32);
            currentCommitment = ethers.keccak256(
                ethers.concat([currentNullifier, currentSecret])
            );
            return currentCommitment;
        }

        // 存入 ETH
        async function depositETH() {
            try {
                const amount = document.getElementById('depositAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('请输入有效的存款金额');
                }

                const amountWei = ethers.parseEther(amount);
                const commitment = generateCommitment();

                const mixerContract = new ethers.Contract(
                    CONTRACT_CONFIG.MIXER_ADDRESS,
                    MIXER_ABI,
                    signer
                );

                document.getElementById('depositInfo').innerHTML = `
                    <div class="info">📤 正在存入 ${amount} ETH...</div>
                `;

                const tx = await mixerContract.deposit(
                    commitment,
                    ethers.ZeroAddress, // ETH 使用零地址
                    amountWei,
                    { value: amountWei }
                );

                document.getElementById('depositInfo').innerHTML = `
                    <div class="info">⏳ 交易已提交，等待确认...<br>交易哈希: ${tx.hash}</div>
                `;

                await tx.wait();

                document.getElementById('depositInfo').innerHTML = `
                    <div class="info">
                        <strong>✅ 存款成功！</strong><br>
                        金额: ${amount} ETH<br>
                        交易哈希: ${tx.hash}<br>
                        隐私凭证: ${commitment}<br>
                        <small>请保存好您的隐私凭证，提取时需要使用</small>
                    </div>
                `;

            } catch (error) {
                document.getElementById('depositInfo').innerHTML = `
                    <div class="error">❌ 存款失败: ${error.message}</div>
                `;
                console.error('存款错误:', error);
            }
        }

        // 借入 DAI
        async function borrowDAI() {
            try {
                if (!currentCommitment) {
                    throw new Error('请先进行 ETH 存款');
                }

                const amount = document.getElementById('borrowAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('请输入有效的借款金额');
                }

                const amountWei = ethers.parseUnits(amount, 18); // DAI 是 18 位小数

                const collateralManagerContract = new ethers.Contract(
                    CONTRACT_CONFIG.COLLATERAL_MANAGER_ADDRESS,
                    COLLATERAL_MANAGER_ABI,
                    signer
                );

                document.getElementById('borrowInfo').innerHTML = `
                    <div class="info">📤 正在借入 ${amount} DAI...</div>
                `;

                const tx = await collateralManagerContract.lockAndBorrow(
                    currentCommitment,
                    CONTRACT_CONFIG.DAI_ADDRESS,
                    amountWei
                );

                document.getElementById('borrowInfo').innerHTML = `
                    <div class="info">⏳ 交易已提交，等待确认...<br>交易哈希: ${tx.hash}</div>
                `;

                await tx.wait();

                // 检查 DAI 余额
                const daiContract = new ethers.Contract(
                    CONTRACT_CONFIG.DAI_ADDRESS,
                    ERC20_ABI,
                    signer
                );
                const daiBalance = await daiContract.balanceOf(userAddress);
                const daiBalanceFormatted = ethers.formatUnits(daiBalance, 18);

                document.getElementById('borrowInfo').innerHTML = `
                    <div class="info">
                        <strong>✅ 借款成功！</strong><br>
                        借入金额: ${amount} DAI<br>
                        当前 DAI 余额: ${daiBalanceFormatted} DAI<br>
                        交易哈希: ${tx.hash}
                    </div>
                `;

            } catch (error) {
                document.getElementById('borrowInfo').innerHTML = `
                    <div class="error">❌ 借款失败: ${error.message}</div>
                `;
                console.error('借款错误:', error);
            }
        }

        // 提取 ETH
        async function withdrawETH() {
            try {
                if (!currentCommitment || !currentNullifier || !currentSecret) {
                    throw new Error('请先进行存款和借贷操作');
                }

                const mixerContract = new ethers.Contract(
                    CONTRACT_CONFIG.MIXER_ADDRESS,
                    MIXER_ABI,
                    signer
                );

                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="info">📤 正在提取 ETH...</div>
                `;

                const tx = await mixerContract.withdraw(
                    userAddress,
                    currentNullifier,
                    currentSecret
                );

                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="info">⏳ 交易已提交，等待确认...<br>交易哈希: ${tx.hash}</div>
                `;

                await tx.wait();

                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="info">
                        <strong>✅ 提取成功！</strong><br>
                        交易哈希: ${tx.hash}<br>
                        ETH 已返回到您的钱包
                    </div>
                `;

            } catch (error) {
                document.getElementById('withdrawInfo').innerHTML = `
                    <div class="error">❌ 提取失败: ${error.message}</div>
                `;
                console.error('提取错误:', error);
            }
        }

        // 检查合约状态
        async function checkContractStatus() {
            try {
                if (!provider) {
                    throw new Error('请先连接钱包');
                }

                document.getElementById('contractStatus').innerHTML = `
                    <div class="info">📊 正在检查合约状态...</div>
                `;

                // 检查合约地址是否有代码
                const mixerCode = await provider.getCode(CONTRACT_CONFIG.MIXER_ADDRESS);
                const lendingPoolCode = await provider.getCode(CONTRACT_CONFIG.LENDING_POOL_ADDRESS);
                const collateralManagerCode = await provider.getCode(CONTRACT_CONFIG.COLLATERAL_MANAGER_ADDRESS);

                let status = `
                    <div class="info">
                        <strong>📋 合约状态检查</strong><br>
                        Mixer: ${mixerCode !== '0x' ? '✅ 已部署' : '❌ 未部署'}<br>
                        LendingPool: ${lendingPoolCode !== '0x' ? '✅ 已部署' : '❌ 未部署'}<br>
                        CollateralManager: ${collateralManagerCode !== '0x' ? '✅ 已部署' : '❌ 未部署'}<br>
                `;

                // 如果有当前存款，检查存款状态
                if (currentCommitment) {
                    const mixerContract = new ethers.Contract(
                        CONTRACT_CONFIG.MIXER_ADDRESS,
                        MIXER_ABI,
                        provider
                    );

                    const depositInfo = await mixerContract.getDeposit(currentCommitment);
                    status += `
                        <br><strong>当前存款状态:</strong><br>
                        代币: ${depositInfo[0] === ethers.ZeroAddress ? 'ETH' : depositInfo[0]}<br>
                        金额: ${ethers.formatEther(depositInfo[1])} ETH<br>
                        已提取: ${depositInfo[2] ? '是' : '否'}<br>
                        已锁定: ${depositInfo[3] ? '是' : '否'}
                    `;
                }

                status += '</div>';
                document.getElementById('contractStatus').innerHTML = status;

            } catch (error) {
                document.getElementById('contractStatus').innerHTML = `
                    <div class="error">❌ 检查失败: ${error.message}</div>
                `;
                console.error('状态检查错误:', error);
            }
        }

        // 页面加载时的提示
        window.addEventListener('load', function () {
            if (!window.ethereum) {
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">
                        ❌ 未检测到 MetaMask<br>
                        请安装 MetaMask 浏览器插件后刷新页面
                    </div>
                `;
            }
        });
    </script>
</body>

</html>