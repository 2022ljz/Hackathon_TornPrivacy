<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERC-20 ApproveåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 300px;
            margin: 5px;
        }

        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .code {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” ERC-20 ApproveåŠŸèƒ½æµ‹è¯•</h1>

        <div class="info">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æˆ‘ä»¬çš„Privacy Token (TPT)çš„ERC-20æ ‡å‡†approveåŠŸèƒ½</p>
            <p><strong>åˆçº¦åœ°å€:</strong> <span class="code">0x5FbDB2315678afecb367f032d93F642f64180aa3</span></p>
            <p><strong>ç½‘ç»œ:</strong> Localhost (Chain ID: 31337)</p>
        </div>

        <div class="section">
            <h3>ğŸ”— 1. è¿æ¥é’±åŒ…</h3>
            <button id="connectBtn" onclick="connectWallet()">è¿æ¥MetaMask</button>
            <div id="walletStatus"></div>
        </div>

        <div class="section">
            <h3>ğŸ’° 2. æŸ¥çœ‹ä½™é¢</h3>
            <button onclick="checkBalance()">æŸ¥çœ‹TPTä½™é¢</button>
            <div id="balanceStatus"></div>
        </div>

        <div class="section">
            <h3>âœ… 3. Approveæˆæƒ</h3>
            <input type="text" id="spenderAddress" placeholder="æˆæƒåœ°å€ (0x...)" />
            <input type="number" id="approveAmount" placeholder="æˆæƒæ•°é‡" value="100" />
            <button onclick="approveTokens()">æˆæƒ TPT</button>
            <div id="approveStatus"></div>
        </div>

        <div class="section">
            <h3>ğŸ” 4. æŸ¥çœ‹æˆæƒé¢åº¦</h3>
            <input type="text" id="checkSpenderAddress" placeholder="æŸ¥è¯¢åœ°å€ (0x...)" />
            <button onclick="checkAllowance()">æŸ¥è¯¢æˆæƒé¢åº¦</button>
            <div id="allowanceStatus"></div>
        </div>

        <div class="section">
            <h3>ğŸ’¸ 5. è½¬è´¦æµ‹è¯•</h3>
            <input type="text" id="transferTo" placeholder="æ¥æ”¶åœ°å€ (0x...)" />
            <input type="number" id="transferAmount" placeholder="è½¬è´¦æ•°é‡" value="10" />
            <button onclick="transferTokens()">è½¬è´¦ TPT</button>
            <div id="transferStatus"></div>
        </div>

        <div id="logs" class="section" style="display: none;">
            <h3>ğŸ“œ æ“ä½œæ—¥å¿—</h3>
            <div id="logContent" class="code"></div>
        </div>
    </div>

    <!-- ä½¿ç”¨å¤šä¸ªCDNå¤‡é€‰ -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // æ£€æŸ¥ethersæ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof ethers === 'undefined') {
            console.error('Ethers.js åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            document.write('<script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"><\/script>');
        }

        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        const CHAIN_ID = 31337;

        // ERC-20 ABI (ç®€åŒ–ç‰ˆ)
        const ERC20_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "event Transfer(address indexed from, address indexed to, uint256 value)",
            "event Approval(address indexed owner, address indexed spender, uint256 value)"
        ];

        let provider, signer, contract, userAddress;

        function log(message, type = 'info') {
            console.log(message);
            const logsDiv = document.getElementById('logs');
            const logContent = document.getElementById('logContent');
            logsDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        async function connectWallet() {
            try {
                // æ£€æŸ¥ethersæ˜¯å¦å·²åŠ è½½
                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.js åº“æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }

                if (typeof window.ethereum !== 'undefined') {
                    // å…ˆè¯·æ±‚è¿æ¥è´¦æˆ·
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (accounts.length === 0) {
                        throw new Error('æœªæ‰¾åˆ°è´¦æˆ·ï¼Œè¯·ç¡®è®¤MetaMaskå·²è§£é”');
                    }

                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();

                    // æ£€æŸ¥ç½‘ç»œ
                    const network = await provider.getNetwork();
                    if (network.chainId !== CHAIN_ID) {
                        throw new Error(`è¯·åˆ‡æ¢åˆ°æœ¬åœ°ç½‘ç»œ (Chain ID: ${CHAIN_ID}), å½“å‰: ${network.chainId}`);
                    }

                    contract = new ethers.Contract(CONTRACT_ADDRESS, ERC20_ABI, signer);

                    document.getElementById('walletStatus').innerHTML =
                        `<div class="success">âœ… é’±åŒ…å·²è¿æ¥: ${userAddress}<br/>ç½‘ç»œ: ${network.name || 'localhost'} (${network.chainId})</div>`;

                    log(`é’±åŒ…è¿æ¥æˆåŠŸ: ${userAddress}`);
                    log(`ç½‘ç»œ: ${network.name || 'localhost'} (Chain ID: ${network.chainId})`);

                    // è·å–åŸºæœ¬ä¿¡æ¯
                    try {
                        const name = await contract.name();
                        const symbol = await contract.symbol();
                        const decimals = await contract.decimals();
                        log(`åˆçº¦ä¿¡æ¯: ${name} (${symbol}), ç²¾åº¦: ${decimals}`);
                    } catch (contractError) {
                        log(`åˆçº¦ä¿¡æ¯è·å–å¤±è´¥: ${contractError.message}`, 'error');
                        throw new Error(`æ— æ³•è¿æ¥åˆ°åˆçº¦ï¼Œè¯·ç¡®è®¤åˆçº¦å·²éƒ¨ç½²: ${contractError.message}`);
                    }

                } else {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }
            } catch (error) {
                document.getElementById('walletStatus').innerHTML =
                    `<div class="error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkBalance() {
            try {
                if (!contract) throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');

                const balance = await contract.balanceOf(userAddress);
                const decimals = await contract.decimals();
                const formattedBalance = ethers.utils.formatUnits(balance, decimals);

                document.getElementById('balanceStatus').innerHTML =
                    `<div class="success">ğŸ’° æ‚¨çš„TPTä½™é¢: ${formattedBalance}</div>`;

                log(`ä½™é¢æŸ¥è¯¢: ${formattedBalance} TPT`);

            } catch (error) {
                document.getElementById('balanceStatus').innerHTML =
                    `<div class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
                log(`ä½™é¢æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function approveTokens() {
            try {
                if (!contract) throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');

                const spender = document.getElementById('spenderAddress').value;
                const amount = document.getElementById('approveAmount').value;

                if (!spender || !amount) throw new Error('è¯·è¾“å…¥æˆæƒåœ°å€å’Œæ•°é‡');

                const decimals = await contract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);

                log(`å¼€å§‹æˆæƒ: ${amount} TPT ç»™ ${spender}`);

                const tx = await contract.approve(spender, amountWei);

                document.getElementById('approveStatus').innerHTML =
                    `<div class="info">â³ äº¤æ˜“æäº¤ä¸­... TxHash: ${tx.hash}</div>`;

                log(`äº¤æ˜“æäº¤: ${tx.hash}`);

                const receipt = await tx.wait();

                document.getElementById('approveStatus').innerHTML =
                    `<div class="success">âœ… æˆæƒæˆåŠŸï¼Gasè´¹ç”¨: ${receipt.gasUsed.toString()}</div>`;

                log(`æˆæƒæˆåŠŸ! Gas: ${receipt.gasUsed.toString()}`);

            } catch (error) {
                document.getElementById('approveStatus').innerHTML =
                    `<div class="error">âŒ æˆæƒå¤±è´¥: ${error.message}</div>`;
                log(`æˆæƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkAllowance() {
            try {
                if (!contract) throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');

                const spender = document.getElementById('checkSpenderAddress').value;
                if (!spender) throw new Error('è¯·è¾“å…¥æŸ¥è¯¢åœ°å€');

                const allowance = await contract.allowance(userAddress, spender);
                const decimals = await contract.decimals();
                const formattedAllowance = ethers.utils.formatUnits(allowance, decimals);

                document.getElementById('allowanceStatus').innerHTML =
                    `<div class="success">ğŸ” æˆæƒé¢åº¦: ${formattedAllowance} TPT</div>`;

                log(`æˆæƒé¢åº¦æŸ¥è¯¢: ${formattedAllowance} TPT ç»™ ${spender}`);

            } catch (error) {
                document.getElementById('allowanceStatus').innerHTML =
                    `<div class="error">âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
                log(`æˆæƒé¢åº¦æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function transferTokens() {
            try {
                if (!contract) throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');

                const to = document.getElementById('transferTo').value;
                const amount = document.getElementById('transferAmount').value;

                if (!to || !amount) throw new Error('è¯·è¾“å…¥æ¥æ”¶åœ°å€å’Œè½¬è´¦æ•°é‡');

                const decimals = await contract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);

                log(`å¼€å§‹è½¬è´¦: ${amount} TPT åˆ° ${to}`);

                const tx = await contract.transfer(to, amountWei);

                document.getElementById('transferStatus').innerHTML =
                    `<div class="info">â³ è½¬è´¦æäº¤ä¸­... TxHash: ${tx.hash}</div>`;

                log(`è½¬è´¦æäº¤: ${tx.hash}`);

                const receipt = await tx.wait();

                document.getElementById('transferStatus').innerHTML =
                    `<div class="success">âœ… è½¬è´¦æˆåŠŸï¼Gasè´¹ç”¨: ${receipt.gasUsed.toString()}</div>`;

                log(`è½¬è´¦æˆåŠŸ! Gas: ${receipt.gasUsed.toString()}`);

            } catch (error) {
                document.getElementById('transferStatus').innerHTML =
                    `<div class="error">âŒ è½¬è´¦å¤±è´¥: ${error.message}</div>`;
                log(`è½¬è´¦å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function () {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');

            // æ£€æŸ¥ethersåº“æ˜¯å¦åŠ è½½
            if (typeof ethers === 'undefined') {
                document.getElementById('walletStatus').innerHTML =
                    `<div class="error">âŒ ethers.jsåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢</div>`;
                log('ethers.jsåº“æœªåŠ è½½', 'error');
                return;
            } else {
                log(`ethers.jsåº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬: ${ethers.version || 'æœªçŸ¥'}`);
            }

            // æ£€æŸ¥MetaMask
            if (typeof window.ethereum === 'undefined') {
                document.getElementById('walletStatus').innerHTML =
                    `<div class="error">âŒ æœªæ£€æµ‹åˆ°MetaMaskï¼Œè¯·å…ˆå®‰è£…MetaMaské’±åŒ…</div>`;
                log('æœªæ£€æµ‹åˆ°MetaMask', 'error');
            } else {
                log('æ£€æµ‹åˆ°MetaMask');
            }

            // å¡«å……æµ‹è¯•åœ°å€
            document.getElementById('spenderAddress').value = "0x70997970C51812dc3A010C7d01b50e0d17dc79C8";
            document.getElementById('checkSpenderAddress').value = "0x70997970C51812dc3A010C7d01b50e0d17dc79C8";
            document.getElementById('transferTo').value = "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC";

            log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        };
    </script>
</body>

</html>